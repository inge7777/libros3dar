<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>${APP_NAME}</title>

    <!-- CRÍTICO: Cargar A-Frame y AR.js aquí para asegurar la compatibilidad -->
    <!-- Versiones estables y compatibles: A-Frame 1.3.0 con AR.js 3.4.5 -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>
    
    <style>
        body { font-family: Arial; background: #f4f4f4; margin: 0; padding: 20px; }
        .center-container { text-align: center; margin-top: 50px; }
        #login, #main, #ar-container, #botonCerrarAR, #loading-screen { display: none; }
        .boton {
            padding: 13px 24px;
            margin: 10px 0;
            font-size: 17px;
            border-radius: 7px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .boton:hover:not(:disabled) { opacity: 0.8; }
        .boton:disabled { opacity: 0.5; cursor: not-allowed; }
        .propaganda { background: #f00; color: white; }
        .explicacion { background: #007bff; color: white; }
        .ar-button { background: #28a745; color: white; }
        #msg { color: red; min-height: 20px; margin-top: 10px; }
        #clave { font-size: 18px; width: 220px; padding: 4px; }
        #ar-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; }
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); color: white; z-index: 300;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; font-size: 24px;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #3498db;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-top: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-screen">
        <div class="loader"></div>
        <p id="loading-text">Cargando...</p>
        <p id="debug-status" style="font-size: 16px; color: #ccc; margin-top: 10px;"></p>
    </div>
    
    <div id="login" class="center-container">
        <h2>Ingresa clave de activación</h2>
        <input id="clave" type="text" maxlength="24" placeholder="Clave o Token" />
        <br /><br />
        <button class="boton" onclick="activar()">Activar</button>
        <div id="msg"></div>
    </div>
    
    <div id="main" class="center-container">
        ${PROPAGANDA_BUTTON}
        ${EXPLANATION_BUTTON}
        <br />
        <button id="btnIniciarAR" class="boton ar-button" onclick="iniciarRealidadAumentada()">Iniciar Realidad Aumentada</button>
    </div>
    
    <div id="ar-container">
        <a-scene embedded arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false;">
            ${AR_MARKERS_HTML}
            <a-entity camera></a-entity>
        </a-scene>
    </div>
    
    <button id="botonCerrarAR" onclick="cerrarAR()" class="boton" style="position: fixed; top: 10px; right: 10px; z-index: 200;">
        Salir AR
    </button>

    <script>
        let isCapacitorReady = false;
        let isARReady = false;
        const maxRetries = 50;
        let capacitorRetries = 0;

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOMContentLoaded: Documento HTML cargado.');
            updateDebugStatus('DOM cargado, esperando frameworks...');

            window.addEventListener('load', () => {
                if (typeof AFRAME !== 'undefined' && typeof ARjs !== 'undefined' && !AFRAME.components['markerhandler']) {
                    AFRAME.registerComponent('markerhandler', {
                        init: function () {
                            this.el.addEventListener('markerFound', () => {
                                this.el.setAttribute('visible', true);
                                console.log('Marcador ENCONTRADO:', this.el.id);
                            });
                            this.el.addEventListener('markerLost', () => {
                                this.el.setAttribute('visible', false);
                                console.log('Marcador PERDIDO:', this.el.id);
                            });
                        }
                    });
                    console.log('Componente markerhandler registrado.');
                    isARReady = true;
                    updateDebugStatus('Frameworks de AR listos.');
                    checkActivation();
                }
            });

            waitForCapacitor();
        });

        function updateDebugStatus(message) {
            const debugElement = document.getElementById('debug-status');
            if (debugElement) {
                debugElement.innerText = message;
            }
        }

        function waitForCapacitor() {
            capacitorRetries++;
            console.log(`waitForCapacitor: Verificando Capacitor... Intento ${capacitorRetries}`);
            updateDebugStatus(`Verificando Capacitor... Intento ${capacitorRetries}`);

            if (typeof window.Capacitor !== 'undefined' && window.Capacitor.isNative) {
                console.log('Capacitor detectado y es entorno nativo.');
                isCapacitorReady = true;
                if(isARReady) checkActivation();
                return;
            }
            
            if (typeof window.Capacitor !== 'undefined' && !window.Capacitor.isNative) {
                console.log('Capacitor detectado pero no es entorno nativo (posiblemente web).');
                isCapacitorReady = true;
                if(isARReady) checkActivation();
                return;
            }

            if (capacitorRetries > maxRetries) {
                console.warn('Timeout esperando Capacitor, asumiendo entorno web o fallido.');
                updateDebugStatus('Timeout. La app podría no ser nativa.');
                isCapacitorReady = false;
                if(isARReady) checkActivation();
                return;
            }

            setTimeout(waitForCapacitor, 100);
        }

        async function checkActivation() {
            console.log('checkActivation: Comprobando estado de activación...');
            const activated = localStorage.getItem('activated');
            if (activated === 'true') {
                console.log('Aplicación activada previamente. Mostrando interfaz principal.');
                updateDebugStatus('Activado. Cargando interfaz principal...');
                document.getElementById('login').style.display = 'none';
                document.getElementById('main').style.display = 'block';
            } else {
                console.log('Aplicación no activada. Mostrando pantalla de login.');
                updateDebugStatus('No activado. Mostrando login...');
                document.getElementById('login').style.display = 'block';
            }
            document.getElementById('loading-screen').style.display = 'none';
        }

        async function activar() {
            console.log('activar: Intentando activar...');
            updateDebugStatus('Activando...');
            const clave = document.getElementById('clave').value.trim().toUpperCase();
            const device_id = getDeviceId();
            
            try {
                console.log(`Enviando petición a ${BACKEND_URL} con token: ${clave}, device_id: ${device_id}`);
                const response = await fetch(`${BACKEND_URL}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: "token=" + encodeURIComponent(clave) + "&device_id=" + encodeURIComponent(device_id)
                });
                const data = await response.json();
                const msg = document.getElementById('msg');
                if (data.status === 'activado') {
                    console.log('Activación exitosa.');
                    localStorage.setItem('activated', 'true');
                    msg.style.color = 'green';
                    msg.innerText = '¡Activación correcta!';
                    updateDebugStatus('Activación correcta. Redirigiendo...');
                    
                    setTimeout(() => {
                        document.getElementById('login').style.display = 'none';
                        document.getElementById('main').style.display = 'block';
                    }, 1500);
                    
                } else {
                    console.warn('Activación fallida:', data.message);
                    msg.style.color = 'red';
                    msg.innerText = data.message || 'Clave incorrecta.';
                    updateDebugStatus('Activación fallida.');
                }
            } catch(error) {
                console.error('Error de conexión con el servidor:', error);
                document.getElementById('msg').innerText = 'No se pudo conectar con el servidor. Verifica la URL y tu conexión.';
                updateDebugStatus('Error de conexión.');
            }
        }

        function getDeviceId() {
            let id = localStorage.getItem('device_id');
            if (!id) {
                id = 'xxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    let r = Math.random()*16|0, v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
                localStorage.setItem('device_id', id);
                console.log('Generado nuevo Device ID:', id);
            } else {
                console.log('Usando Device ID existente:', id);
            }
            return id;
        }

        async function iniciarRealidadAumentada() {
            console.log('iniciarRealidadAumentada: Iniciando AR...');
            updateDebugStatus('Iniciando cámara...');
            document.getElementById('loading-text').innerText = "Iniciando cámara...";
            document.getElementById('loading-screen').style.display = 'flex';
            document.getElementById('btnIniciarAR').disabled = true;

            try {
                // Solo solicitar permisos de cámara si Capacitor está listo y es nativo
                if (isCapacitorReady && window.Capacitor.isNative) {
                    console.log('Solicitando permisos de cámara a través de Capacitor...');
                    const cameraPermission = await window.Capacitor.Plugins.Camera.requestPermissions();
                    
                    if (cameraPermission.camera !== 'granted') {
                        throw new Error('Permiso de cámara denegado por Capacitor.');
                    }
                    console.log('Permiso de cámara concedido por Capacitor.');
                } else {
                    console.log('No es entorno nativo o Capacitor no está listo. No se solicitan permisos via Capacitor.');
                    // En un entorno web, getUserMedia solicitará permisos directamente.
                }
                
                document.getElementById('main').style.display = 'none';
                document.getElementById('ar-container').style.display = 'block';
                document.getElementById('botonCerrarAR').style.display = 'block';
                
                if (isARReady) {
                    console.log('A-Frame y AR.js precargados. Ocultando pantalla de carga...');
                    updateDebugStatus('AR listo. Disfruta!');
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('btnIniciarAR').disabled = false;
                } else {
                    throw new Error('A-Frame o AR.js no se cargaron correctamente.');
                }
                
            } catch (e) {
                console.error("Error al iniciar la Realidad Aumentada:", e);
                alert('No se pudo iniciar la cámara. Por favor, asegúrate de que la aplicación tenga permisos de cámara y que estés en un dispositivo compatible. Error: ' + e.message);
                updateDebugStatus('Error AR: ' + e.message);
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('btnIniciarAR').disabled = false;
                document.getElementById('main').style.display = 'block';
            }
        }

        function cerrarAR() {
            console.log('cerrarAR: Saliendo de la Realidad Aumentada.');
            document.getElementById('ar-container').style.display = 'none';
            document.getElementById('main').style.display = 'block';
            document.getElementById('botonCerrarAR').style.display = 'none';
            updateDebugStatus('Regresando a la interfaz principal.');
        }

    </script>
</body>
</html>
