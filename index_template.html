<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>${APP_NAME}</title>

    <!-- CRÍTICO: Cargar A-Frame y AR.js aquí para asegurar la compatibilidad -->
    <!-- Versiones estables y compatibles: A-Frame 1.3.0 con AR.js 3.4.5 -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.5/aframe/build/aframe-ar.js"></script>
    
    <style>
        body, html {
            height: 100%;
            width: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden; /* Evita barras de scroll innecesarias */
        }
        body { font-family: Arial; background: #f4f4f4; }
        .center-container { text-align: center; margin-top: 50px; }
        #login, #main, #ar-container, #botonCerrarAR { display: none; }
        .boton {
            padding: 13px 24px;
            margin: 10px 0;
            font-size: 17px;
            border-radius: 7px;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .boton:hover:not(:disabled) { opacity: 0.8; }
        .boton:disabled { opacity: 0.5; cursor: not-allowed; }
        .propaganda { background: #f00; color: white; }
        .explicacion { background: #007bff; color: white; }
        .ar-button { background: #28a745; color: white; }
        #msg { color: red; min-height: 20px; margin-top: 10px; }
        #clave { font-size: 18px; width: 220px; padding: 4px; }
        #ar-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 100; }
        #loading-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); color: white; z-index: 300;
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; font-size: 24px;
        }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #3498db;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite; margin-top: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-screen" style="display: flex;">
        <div class="loader"></div>
        <p id="loading-text">Cargando...</p>
    </div>
    
    <div id="login" class="center-container">
        <h2>Ingresa clave de activación</h2>
        <input id="clave" type="text" maxlength="24" placeholder="Clave o Token" />
        <br /><br />
        <button class="boton" onclick="activar()">Activar</button>
        <div id="msg"></div>
    </div>
    
    <div id="main" class="center-container">
        ${PROPAGANDA_BUTTON}
        ${EXPLANATION_BUTTON}
        <br />
        <button id="btnIniciarAR" class="boton ar-button" onclick="iniciarRealidadAumentada()">Iniciar Realidad Aumentada</button>
    </div>
    
    <div id="ar-container">
        <!-- La escena de A-Frame se inyectará aquí dinámicamente para evitar el inicio automático de la cámara -->
    </div>
    
    <button id="botonCerrarAR" onclick="cerrarAR()" class="boton" style="position: fixed; top: 10px; right: 10px; z-index: 200; display: none;">
        Salir AR
    </button>

    <script>
        const BACKEND_URL = '${BACKEND_URL}';
        let isDomReady = false;
        let isARReady = false;
        let isCapacitorReady = false;

        function tryInitApp() {
            if (isDomReady && isARReady && isCapacitorReady) {
                console.log("All systems go! Initializing app.");
                checkActivation();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM ready.');
            isDomReady = true;

            if (typeof AFRAME !== 'undefined' && typeof ARjs !== 'undefined') {
                AFRAME.registerComponent('markerhandler', {
                    init: function () {
                        this.el.addEventListener('markerFound', () => { this.el.setAttribute('visible', true); });
                        this.el.addEventListener('markerLost', () => { this.el.setAttribute('visible', false); });
                    }
                });
                console.log('AR libraries ready.');
                isARReady = true;
            } else {
                console.error('AR libraries not found!');
                alert('Error: No se pudieron cargar las librerías de Realidad Aumentada.');
            }
            tryInitApp();
        });

        (function waitForCapacitor() {
            if (window.Capacitor && window.Capacitor.isReady) {
                console.log('Capacitor ready.');
                isCapacitorReady = true;
                tryInitApp();
            } else {
                setTimeout(() => {
                    if (window.Capacitor) {
                        console.log('Capacitor ready (delayed).');
                        isCapacitorReady = true;
                    } else {
                        console.warn('Capacitor not found, assuming web environment.');
                        isCapacitorReady = true; // Treat as "ready" for web
                    }
                    tryInitApp();
                }, 500);
            }
        })();

        function checkActivation() {
            if (localStorage.getItem('activated') === 'true') {
                document.getElementById('login').style.display = 'none';
                document.getElementById('main').style.display = 'block';
            } else {
                document.getElementById('login').style.display = 'block';
            }
            document.getElementById('loading-screen').style.display = 'none';
        }

        async function activar() {
            const clave = document.getElementById('clave').value.trim().toUpperCase();
            const device_id = getDeviceId();
            const msg = document.getElementById('msg');
            msg.innerText = 'Activando...';

            try {
                const response = await fetch(BACKEND_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: `token=${encodeURIComponent(clave)}&device_id=${encodeURIComponent(device_id)}`
                });
                const data = await response.json();
                if (data.status === 'activado') {
                    localStorage.setItem('activated', 'true');
                    msg.style.color = 'green';
                    msg.innerText = '¡Activación correcta!';
                    setTimeout(() => {
                        document.getElementById('login').style.display = 'none';
                        document.getElementById('main').style.display = 'block';
                    }, 1500);
                } else {
                    msg.style.color = 'red';
                    msg.innerText = data.message || 'Clave incorrecta.';
                }
            } catch(error) {
                msg.innerText = 'Error de conexión con el servidor.';
            }
        }

        function getDeviceId() {
            let id = localStorage.getItem('device_id');
            if (!id) {
                id = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c =>
                    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                );
                localStorage.setItem('device_id', id);
            }
            return id;
        }

        async function iniciarRealidadAumentada() {
            document.getElementById('loading-text').innerText = "Iniciando cámara...";
            document.getElementById('loading-screen').style.display = 'flex';
            document.getElementById('btnIniciarAR').disabled = true;

            try {
                if (window.Capacitor && window.Capacitor.isNativePlatform()) {
                    const perm = await window.Capacitor.Plugins.Camera.requestPermissions();
                    if (perm.camera !== 'granted') throw new Error('Permiso de cámara denegado.');
                }

                const arContainer = document.getElementById('ar-container');
                arContainer.innerHTML = '';
                
                const scene = document.createElement('a-scene');
                scene.setAttribute('embedded', '');
                scene.setAttribute('arjs', 'trackingMethod: best; sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;');
                
                scene.innerHTML = `${AR_MARKERS_HTML}<a-entity camera></a-entity>`;
                arContainer.appendChild(scene);

                document.getElementById('main').style.display = 'none';
                document.getElementById('ar-container').style.display = 'block';
                document.getElementById('botonCerrarAR').style.display = 'block';
                
                setTimeout(() => {
                    document.getElementById('loading-screen').style.display = 'none';
                    document.getElementById('btnIniciarAR').disabled = false;
                }, 1000);
                
            } catch (e) {
                alert('No se pudo iniciar la cámara. Error: ' + e.message);
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('btnIniciarAR').disabled = false;
                document.getElementById('main').style.display = 'block';
            }
        }

        function cerrarAR() {
            const arContainer = document.getElementById('ar-container');
            if (arContainer.firstChild) {
                arContainer.firstChild.pause();
            }
            arContainer.innerHTML = '';
            document.getElementById('ar-container').style.display = 'none';
            document.getElementById('main').style.display = 'block';
            document.getElementById('botonCerrarAR').style.display = 'none';
        }
    </script>
</body>
</html>


